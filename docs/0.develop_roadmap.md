# Announce-Go API 개발 로드맵

> 이 문서는 전체 개발 흐름을 정리한 로드맵입니다.
> 각 Phase 구현 시 별도의 세부 계획을 작성합[zippy-nibbling-dahl.md](../../../.claude/plans/zippy-nibbling-dahl.md)니다.

## 기술적 결정사항
- **파일 저장**: Local + S3 추상화 (초기 Local, 추후 S3 지원)
- **삭제 정책**: Hard delete

---

## 현재 상태 (Phase 1 완료)
- Core: FastAPI, SQLAlchemy async, 설정 관리
- 인증: Login/Logout/Session (Redis/Memory store)
- User 모델: id, login_id, email, password_hash, role, approval_status
- Crawler: Playwright 브라우저 풀, Naver 순위 추출
- DB 추상화: SQLite/PostgreSQL 지원

---

## Phase 2: 공통 API + 관리자 회원 관리

### 2.1 새 모델
```
app/models/
├── agency.py              # 업체 확장 프로필
├── advertiser.py          # 광고주 확장 프로필
├── agency_advertiser_mapping.py  # N:N 관계
└── file.py                # 파일 메타데이터
```

| 모델 | 주요 필드 |
|------|----------|
| Agency | user_id(FK), categories(JSON) |
| Advertiser | user_id(FK), business_license_file_id, logo_file_id |
| AgencyAdvertiserMapping | agency_id, advertiser_id (unique) |
| File | original_filename, stored_filename, file_type, mime_type, storage_path |

### 2.3 파일 저장소 추상화
```
app/core/storage/
├── __init__.py
├── abstract_storage.py   # AbstractStorage 인터페이스
├── local_storage.py      # 로컬 파일시스템 구현
└── s3_storage.py         # S3 구현 (나중에)
```
- 환경변수 `STORAGE_TYPE`으로 전환 (local/s3)
- 초기에는 local만 구현, S3는 스켈레톤

### 2.2 API 엔드포인트

**공통 API** (`app/routers/common/`)
| 엔드포인트 | 메서드 | 설명 |
|-----------|--------|------|
| `/signup/check-id/{loginId}` | GET | 아이디 중복 체크 |
| `/signup/advertiser` | POST | 광고주 회원가입 (파일 업로드) |
| `/signup/agency` | POST | 업체 회원가입 |
| `/files/upload` | POST | 파일 업로드 |
| `/files/{fileId}` | GET | 파일 다운로드 |

**관리자 API** (`app/routers/admin/`)
| 엔드포인트 | 메서드 | 설명 |
|-----------|--------|------|
| `/admin/signup-requests` | GET | 가입 요청 목록 |
| `/admin/signup-requests/{id}/approve` | POST | 승인 |
| `/admin/signup-requests/{id}/reject` | POST | 거절 |
| `/admin/advertisers` | GET | 광고주 목록 |
| `/admin/agencies` | GET | 업체 목록 |
| `/admin/agencies/{id}/mappings` | POST | 광고주 매핑 추가 |
| `/admin/agencies/{id}/mappings/{mappingId}` | DELETE | 매핑 삭제 |

### 2.3 서비스/레포지토리
- `services/`: signup_service.py, file_service.py, member_service.py
- `repositories/`: agency_repository.py, advertiser_repository.py, mapping_repository.py, file_repository.py

---

## Phase 3: 순위 관리 (관리자/업체/광고주)

### 3.1 새 모델
```
app/models/tracking/
├── place_rank.py    # PlaceRankTracking, PlaceRankHistory
├── cafe_rank.py     # CafeRankTracking, CafeRankHistory
└── blog_rank.py     # BlogRankTracking, BlogRankHistory
```

| 모델 | 주요 필드 |
|------|----------|
| *RankTracking | agency_id, advertiser_id, keyword, target_url, status, current_round |
| *RankHistory | tracking_id, rank, round_number, checked_date |

### 3.2 API 엔드포인트

**관리자** (`app/routers/admin/`)
- `GET /admin/{type}-rank/realtime` - 실시간 순위 조회 (DB 저장 X)
- `GET /admin/{type}-rank/tracking` - 추적 목록
- `GET /admin/{type}-rank/tracking/{id}` - 추적 상세 + 이력
- `PUT /admin/{type}-rank/tracking/{id}/stop` - 추적 중단

**업체** (`app/routers/agency/`)
- `GET /agency/{type}-rank/realtime` - 실시간 순위
- `GET/POST /agency/{type}-rank/tracking` - 추적 목록/등록
- `GET /agency/{type}-rank/tracking/{id}` - 추적 상세
- `GET /agency/advertisers` - 매핑된 광고주 목록

**광고주** (`app/routers/advertiser/`)
- `GET /advertiser/{type}-rank/tracking` - 추적 목록 (읽기 전용)
- `GET /advertiser/{type}-rank/tracking/{id}` - 추적 상세

### 3.3 핵심 로직
- **라운드 계산**: 25회 노출 = 1 라운드 (순위 없는 날 제외)
- **실시간 vs 추적**: 실시간은 DB 저장 X, 추적은 일일 자동 크롤링

---

## Phase 4: 언론 기사 & 카페 침투

### 4.1 새 모델
```
app/models/work_records/
├── blog_posting.py       # 블로그 포스팅
├── press_article.py      # 언론 기사
└── cafe_infiltration.py  # 카페 침투
```

| 모델 | 주요 필드 |
|------|----------|
| BlogPosting | agency_id, advertiser_id, keyword, url, posting_date |
| PressArticle | advertiser_id, article_date, title, content, url |
| CafeInfiltration | advertiser_id, infiltration_date, title, content, cafe_name |

### 4.2 API 엔드포인트

**관리자**: 언론기사/카페침투 Full CRUD, 블로그포스팅 읽기
**업체**: 블로그포스팅 Full CRUD, 언론기사/카페침투 읽기
**광고주**: 모두 읽기 전용

### 4.3 캘린더 쿼리 지원
- `?year=2024&month=1` - 월별
- `?date=2024-01-15` - 일별

---

## Phase 5: 배치 처리 (Celery)

### 5.1 구조

**단일 컨테이너 방식** — API, Worker, Beat를 하나의 컨테이너에서 실행
- Broker: 기존 Redis 공유
- Worker 동시성: 1 (Playwright 리소스 제한)

```
app/tasks/
├── __init__.py        # Celery app import
├── celery_app.py      # Celery 인스턴스, Beat 스케줄
└── rank_tasks.py      # 순위 크롤링 태스크
```

**수정 파일**
| 파일 | 변경 |
|------|------|
| `app/core/config.py` | `CRAWL_SCHEDULE_HOUR`, `CRAWL_SCHEDULE_MINUTE`, `CRAWL_DELAY_SECONDS` 추가 |
| `requirements.txt` | `celery[redis]` 추가 |
| `Dockerfile` | `start.sh` 엔트리포인트로 변경 |
| `start.sh` | API + Worker + Beat 동시 실행 스크립트 |

### 5.2 배치 로직

```
[Beat] ──schedule──> crawl_all_active_trackings (메인 태스크)
                          │
                          ├── DB: status=ACTIVE 추적 항목 조회
                          │
                          └── 항목별 순차 실행 (2초 딜레이)
                                │
                                ├── type별 크롤러 호출
                                │   ├── place → get_place_rank(keyword, place_id)
                                │   ├── blog  → get_blog_rank(keyword, blog_id, log_no)
                                │   └── cafe  → get_cafe_rank(keyword, cafe_id, article_id)
                                │
                                ├── RankHistory 저장
                                │   ├── tracking_id: 추적 항목 ID
                                │   ├── rank: 순위 (미노출 시 null)
                                │   ├── session_number: current_session 값
                                │   └── checked_at: 크롤링 시점
                                │
                                └── 회차 전환 체크
```

**회차(session) 전환 로직**
- 1회차 = **rank != null인 RankHistory 25개** (미노출은 카운트 제외)
- 현재 `current_session`의 rank != null 히스토리가 25개 이상 → `current_session += 1`

### 5.3 스케줄
- **일일 1시 (KST)**: 모든 활성 추적 항목 크롤링
- **Celery Beat**: `crontab(hour=1, minute=0)`, timezone `Asia/Seoul`
- 각 항목 크롤링 사이 **2초 딜레이** (네이버 차단 방지)

### 5.4 Docker 구성
```dockerfile
# start.sh — 단일 컨테이너에서 3개 프로세스 실행
celery -A app.tasks.celery_app worker --concurrency=1 -l info &
celery -A app.tasks.celery_app beat -l info &
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### 5.5 에러 처리
- 개별 추적 항목 실패 시 다음 항목 계속 진행
- 실패 항목 로그 기록 (structlog)
- Slack 알림은 추후 구현

---

## 구현 순서 & 의존성

```
Phase 2 ─┬─→ Phase 3 ─→ Phase 5
         │
         └─→ Phase 4
```

- Phase 2 완료 후 Phase 3, 4 병렬 진행 가능
- Phase 5는 Phase 3 완료 후 진행

---

## 주요 수정 파일

| 파일 | 변경 내용 |
|------|----------|
| `app/models/user.py` | Agency/Advertiser 관계 추가, rejection_reason 필드 |
| `app/core/config.py` | UPLOAD_DIR, MAX_FILE_SIZE, SLACK_WEBHOOK_URL 추가 |
| `app/core/dependencies.py` | 역할별 접근 제어 패턴 확장 |
| `app/main.py` | 새 라우터 등록 |
| `docker-compose.yml` | Celery worker/beat 서비스 추가 |

---

## 예상 작업량

| Phase | 설명 | 예상 시간 |
|-------|------|----------|
| Phase 2 | 공통 API + 회원 관리 | 18-24시간 |
| Phase 3 | 순위 관리 | 28-36시간 |
| Phase 4 | 작업 기록 | 16-21시간 |
| Phase 5 | 배치 처리 | 19-26시간 |
| **합계** | | **81-107시간** |
