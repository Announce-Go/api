# Phase 2 개발 계획: Common APIs + Admin Member Management

## 개요
- **범위**: 회원가입 API, 파일 업로드, 관리자 회원 관리
- **예상 소요**: 18-24시간
- **의존성**: Phase 1 (Core + 인증) 완료됨 ✅

---

## 구현 순서 (의존성 기반)

### Step 1: 인프라 레이어 (4-5시간)

#### 1.1 Storage 추상화 (신규)
```
app/core/storage/
├── __init__.py
├── abstract_storage.py    # AbstractStorage 인터페이스
├── local_storage.py       # 로컬 파일시스템 구현
└── s3_storage.py          # S3 스켈레톤 (미구현)
```

#### 1.2 Config 수정
**파일**: `app/core/config.py`
```python
# 추가할 설정
UPLOAD_DIR: str = "./uploads"
MAX_FILE_SIZE: int = 10 * 1024 * 1024  # 10MB
ALLOWED_FILE_TYPES: list[str] = ["image/jpeg", "image/png", "image/gif", "application/pdf"]
STORAGE_TYPE: str = "local"  # local, s3
```

#### 1.3 의존성 패키지 추가
```
aiofiles>=23.0.0
python-multipart>=0.0.6
```

---

### Step 2: 모델 레이어 (3-4시간)

#### 2.1 신규 모델
| 파일 | 모델 | 주요 필드 |
|------|------|----------|
| `app/models/file.py` | File | original_filename, stored_filename, file_type, mime_type, storage_path, file_size |
| `app/models/advertiser.py` | Advertiser | user_id(FK), business_license_file_id, logo_file_id |
| `app/models/agency.py` | Agency | user_id(FK), categories(JSON) |
| `app/models/agency_advertiser_mapping.py` | AgencyAdvertiserMapping | agency_id, advertiser_id (unique constraint) |

#### 2.2 기존 모델 수정
**파일**: `app/models/user.py`
```python
# 추가할 관계
advertiser: Mapped[Optional["Advertiser"]] = relationship("Advertiser", back_populates="user", uselist=False)
agency: Mapped[Optional["Agency"]] = relationship("Agency", back_populates="user", uselist=False)
```

---

### Step 3: Repository 레이어 (3-4시간)

#### 3.1 신규 Repository
```
app/repositories/
├── file_repository.py
├── advertiser_repository.py
├── agency_repository.py
└── agency_advertiser_mapping_repository.py
```

#### 3.2 기존 Repository 수정
**파일**: `app/repositories/user_repository.py`
- `get_pending_users()` 메서드 추가
- `exists_by_email()` 메서드 추가
- `update()` 메서드 추가

---

### Step 4: Schema 레이어 (2-3시간)

```
app/schemas/
├── file.py       # FileUploadResponse, FileResponse
├── signup.py     # IdCheckResponse, AdvertiserSignupRequest, AgencySignupRequest, SignupResponse
└── admin.py      # SignupRequestListResponse, ApprovalResponse, AdvertiserListResponse, AgencyListResponse, MappingResponse
```

---

### Step 5: Service 레이어 (4-5시간)

```
app/services/
├── file_service.py           # 파일 업로드/다운로드
├── signup_service.py         # 회원가입 처리
└── admin_member_service.py   # 관리자 회원 관리
```

---

### Step 6: Router 레이어 (4-5시간)

#### 6.1 Common APIs
**파일**: `app/routers/common/signup.py`
| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| GET | `/api/v1/signup/check-id/{loginId}` | ID 중복 확인 | ✗ |
| POST | `/api/v1/signup/advertiser` | 광고주 회원가입 | ✗ |
| POST | `/api/v1/signup/agency` | 업체 회원가입 | ✗ |

**파일**: `app/routers/common/files.py`
| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| POST | `/api/v1/files/upload` | 파일 업로드 (사업자등록증, 로고) | ✗ |
| GET | `/api/v1/files/{fileId}` | 파일 다운로드 | ✗ |

#### 6.2 Admin APIs
**파일**: `app/routers/admin/members.py`
| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| GET | `/api/v1/admin/signup-requests` | 회원가입 승인 요청 목록 (필터, 검색) | Admin |
| GET | `/api/v1/admin/signup-requests/{id}` | 회원가입 승인 요청 상세 | Admin |
| POST | `/api/v1/admin/signup-requests/{id}/approve` | 승인 (업체인 경우 광고주 매핑 포함) | Admin |
| POST | `/api/v1/admin/signup-requests/{id}/reject` | 거절 | Admin |
| GET | `/api/v1/admin/advertisers` | 광고주 목록 (검색) | Admin |
| GET | `/api/v1/admin/advertisers/{id}` | 광고주 상세 및 매핑된 업체 목록 | Admin |
| GET | `/api/v1/admin/agencies` | 업체 목록 (검색) | Admin |
| GET | `/api/v1/admin/agencies/{id}` | 업체 상세 및 매핑된 광고주 목록 | Admin |

---

### Step 7: 통합 및 테스트 (2-3시간)

#### 7.1 Main.py 수정
**파일**: `app/main.py`
- 새 라우터 등록: `signup_router`, `files_router`, `admin_members_router`

#### 7.2 모델 __init__.py 수정
**파일**: `app/models/__init__.py`
- 새 모델 export 추가

---

## 핵심 수정 파일 목록

| 파일 경로 | 작업 |
|----------|------|
| `app/core/config.py` | 파일 업로드 설정 추가 |
| `app/core/storage/` | 신규 디렉토리 (3개 파일) |
| `app/models/user.py` | rejection_reason, relationships 추가 |
| `app/models/file.py` | 신규 |
| `app/models/advertiser.py` | 신규 |
| `app/models/agency.py` | 신규 |
| `app/models/agency_advertiser_mapping.py` | 신규 |
| `app/models/__init__.py` | export 추가 |
| `app/repositories/user_repository.py` | 메서드 추가 |
| `app/repositories/file_repository.py` | 신규 |
| `app/repositories/advertiser_repository.py` | 신규 |
| `app/repositories/agency_repository.py` | 신규 |
| `app/repositories/agency_advertiser_mapping_repository.py` | 신규 |
| `app/schemas/file.py` | 신규 |
| `app/schemas/signup.py` | 신규 |
| `app/schemas/admin.py` | 신규 |
| `app/services/file_service.py` | 신규 |
| `app/services/signup_service.py` | 신규 |
| `app/services/admin_member_service.py` | 신규 |
| `app/routers/common/signup.py` | 신규 |
| `app/routers/common/files.py` | 신규 |
| `app/routers/admin/members.py` | 신규 |
| `app/main.py` | 라우터 등록 |
| `requirements.txt` | aiofiles, python-multipart 추가 |

---

## 주요 구현 패턴

### Storage 추상화
- LocalStorage: 날짜 기반 디렉토리 구조 (`YYYY/MM/DD/uuid.ext`)
- S3Storage: 스켈레톤만 구현 (향후 확장)

### 파일 업로드 플로우
1. 사용자가 `/files/upload`로 파일 업로드 → file_id 반환
2. 회원가입 시 file_id를 요청 body에 포함
3. Advertiser 생성 시 file_id 참조

### 업체 승인 시 광고주 매핑
- approve API 호출 시 `advertiser_ids: [1, 2, 3]` 배열을 함께 전달
- 업체(Agency) 승인과 동시에 AgencyAdvertiserMapping 레코드 생성
- 광고주(Advertiser) 승인 시에는 매핑 없이 승인만 처리

### 트랜잭션 처리
- Service에서 `commit()` 호출
- Repository에서 `flush()`로 즉시 ID 획득

### 인증 플로우
- 회원가입 API: 인증 불필요
- 파일 업로드: 인증 불필요 (회원가입 시 사용)
- 파일 다운로드: 인증 불필요
- Admin API: 관리자 역할 필요 (`require_role("admin")`)

---

## Phase 2 이후 의존성

```
Phase 2 ──┬──→ Phase 3 (순위 추적 관리)
          │
          └──→ Phase 4 (미디어 & 카페 작업)
                    ↓
          Phase 5 (배치 처리 - Celery)
```
