# 개발 계획 (1단계: Core 인프라 + 인증)

## 개요
- **목표**: Settings + Factory 패턴으로 인프라 추상화, 인증 시스템 구현
- **유지 파일**: `app/crawler/naver.py`, `app/crawler/browser_pool.py`
- **나머지**: 전부 새로 생성

## 핵심 설계 원칙
- DB: PostgreSQL / SQLite 설정으로 선택
- Session Store: Redis / In-memory Map 설정으로 선택
- 로컬 환경에서 외부 서비스 없이 실행 가능 (SQLite + Memory)

---

## 디렉토리 구조

```
api/app/
├── main.py                      # FastAPI 엔트리포인트
├── core/
│   ├── config.py                # Settings (Pydantic BaseSettings)
│   ├── factory.py               # Factory 함수들
│   ├── security.py              # 비밀번호 해싱, 세션 토큰 생성
│   ├── dependencies.py          # FastAPI 의존성
│   ├── exceptions.py            # 커스텀 예외
│   ├── interfaces/
│   │   ├── database.py          # AbstractDatabase
│   │   └── session_store.py     # AbstractSessionStore
│   ├── database/
│   │   ├── postgresql.py        # PostgreSQL 구현체
│   │   └── sqlite.py            # SQLite 구현체
│   └── session/
│       ├── redis_store.py       # Redis 구현체
│       └── memory_store.py      # In-memory 구현체
├── models/
│   ├── base.py                  # Base, TimestampMixin
│   └── user.py                  # User 모델
├── schemas/
│   ├── auth.py                  # 인증 스키마
│   └── user.py                  # 사용자 스키마
├── repositories/
│   └── user_repository.py       # UserRepository
├── services/
│   └── auth_service.py          # AuthService
├── routers/
│   └── auth.py                  # /auth/* 라우터
├── crawler/                     # [기존 유지]
│   ├── browser_pool.py
│   └── naver.py
└── scripts/
    └── seed_admin.py            # Admin 시드 스크립트
```

---

## Phase 1: Core 인프라

### 1.1 Settings (`app/core/config.py`)
```python
class DatabaseType(str, Enum):
    POSTGRESQL = "postgresql"
    SQLITE = "sqlite"

class SessionStoreType(str, Enum):
    REDIS = "redis"
    MEMORY = "memory"

class Settings(BaseSettings):
    # App
    APP_ENV: str = "local"
    SECRET_KEY: str

    # Database
    DB_TYPE: DatabaseType = DatabaseType.SQLITE
    POSTGRES_HOST, POSTGRES_PORT, POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB
    SQLITE_PATH: str = "./local.db"

    # Session Store
    SESSION_STORE_TYPE: SessionStoreType = SessionStoreType.MEMORY
    REDIS_HOST, REDIS_PORT, REDIS_DB, REDIS_PASSWORD

    # Session
    SESSION_EXPIRE_SECONDS: int = 86400  # 24h
    REMEMBER_ME_EXPIRE_SECONDS: int = 2592000  # 30d

    # Admin Seed
    ADMIN_LOGIN_ID: str = "admin"
    ADMIN_PASSWORD: str  # 필수
    ADMIN_EMAIL: str = "admin@example.com"
```

### 1.2 인터페이스

**AbstractDatabase** (`app/core/interfaces/database.py`)
- `connect()`, `disconnect()`
- `get_session()` -> AsyncGenerator[AsyncSession]
- `create_tables()`

**AbstractSessionStore** (`app/core/interfaces/session_store.py`)
- `connect()`, `disconnect()`
- `get(session_id)` -> dict | None
- `set(session_id, data, expire)`
- `delete(session_id)`
- `exists(session_id)` -> bool
- `refresh(session_id, expire)` -> bool

### 1.3 구현체

| 인터페이스 | 구현체 | 파일 |
|-----------|--------|------|
| AbstractDatabase | SQLiteDatabase | `app/core/database/sqlite.py` |
| AbstractDatabase | PostgreSQLDatabase | `app/core/database/postgresql.py` |
| AbstractSessionStore | MemorySessionStore | `app/core/session/memory_store.py` |
| AbstractSessionStore | RedisSessionStore | `app/core/session/redis_store.py` |

### 1.4 Factory (`app/core/factory.py`)
- `get_database(settings)` -> AbstractDatabase (싱글턴)
- `get_session_store(settings)` -> AbstractSessionStore (싱글턴)
- `close_all()` -> 모든 연결 종료

---

## Phase 2: 모델 & 스키마

### 2.1 User 모델 (`app/models/user.py`)
```python
class UserRole(str, Enum):
    ADMIN = "admin"
    AGENCY = "agency"
    ADVERTISER = "advertiser"

class ApprovalStatus(str, Enum):
    PENDING = "pending"
    APPROVED = "approved"
    REJECTED = "rejected"

class User(Base, TimestampMixin):
    id: int (PK)
    login_id: str (unique)       # 별도 로그인 ID
    email: str (unique)
    password_hash: str
    name: str
    phone: str | None
    company_name: str | None
    role: UserRole
    approval_status: ApprovalStatus
    is_active: bool
```

### 2.2 인증 스키마 (`app/schemas/auth.py`)
- `LoginRequest`: login_id, password, remember_me
- `LoginResponse`: session_id, user
- `SessionResponse`: authenticated, user
- `LogoutResponse`: success, message

---

## Phase 3: 인증 시스템

### 3.1 AuthService (`app/services/auth_service.py`)
- `login(request)` -> LoginResponse
  - 사용자 조회 (login_id)
  - 비밀번호 검증
  - 승인 상태 확인 (admin 제외)
  - 세션 생성
- `logout(session_id)` -> bool
- `get_session(session_id)` -> SessionResponse

### 3.2 Auth Router (`app/routers/auth.py`)
| Method | Path | 설명 |
|--------|------|------|
| POST | `/auth/login` | 로그인, 세션 쿠키 설정 |
| POST | `/auth/logout` | 로그아웃, 세션 삭제 |
| GET | `/auth/session` | 현재 세션 확인 |

### 3.3 Dependencies (`app/core/dependencies.py`)
- `get_db_session()` -> AsyncSession
- `get_session_store()` -> AbstractSessionStore
- `get_current_user()` -> 세션에서 사용자 정보 추출
- `require_role(*roles)` -> 역할 검증 데코레이터

---

## Phase 4: Admin 시드 스크립트

### `app/scripts/seed_admin.py`
```python
async def seed_admin():
    """
    Admin 계정 생성 (없으면)
    환경변수: ADMIN_LOGIN_ID, ADMIN_PASSWORD, ADMIN_EMAIL
    """
```

실행: `python -m app.scripts.seed_admin`

---

## Phase 5: 설정 파일 & Docker

### 환경 설정 예시

**로컬 (외부 서비스 없음)** - `.env.local`
```env
DB_TYPE=sqlite
SQLITE_PATH=./local.db
SESSION_STORE_TYPE=memory
ADMIN_PASSWORD=admin123
```

**운영** - `.env.prod`
```env
DB_TYPE=postgresql
POSTGRES_HOST=db.example.com
...
SESSION_STORE_TYPE=redis
REDIS_HOST=redis.example.com
...
```

### Docker 구성
- `Dockerfile`: Python 3.11 + FastAPI
- `docker-compose.yml`: API + PostgreSQL + Redis (개발용)

---

## 구현 순서

| 순서 | 작업 | 파일 |
|------|------|------|
| 1 | Settings 클래스 | `app/core/config.py` |
| 2 | Database 인터페이스 | `app/core/interfaces/database.py` |
| 3 | Session Store 인터페이스 | `app/core/interfaces/session_store.py` |
| 4 | SQLite 구현체 | `app/core/database/sqlite.py` |
| 5 | PostgreSQL 구현체 | `app/core/database/postgresql.py` |
| 6 | Memory 세션 구현체 | `app/core/session/memory_store.py` |
| 7 | Redis 세션 구현체 | `app/core/session/redis_store.py` |
| 8 | Factory | `app/core/factory.py` |
| 9 | Base 모델 | `app/models/base.py` |
| 10 | User 모델 | `app/models/user.py` |
| 11 | 인증 스키마 | `app/schemas/auth.py` |
| 12 | Security 유틸 | `app/core/security.py` |
| 13 | User Repository | `app/repositories/user_repository.py` |
| 14 | Auth Service | `app/services/auth_service.py` |
| 15 | Dependencies | `app/core/dependencies.py` |
| 16 | Auth Router | `app/routers/auth.py` |
| 17 | Main App | `app/main.py` |
| 18 | Admin 시드 스크립트 | `app/scripts/seed_admin.py` |
| 19 | 환경 설정 파일 | `.env.example` |
| 20 | requirements.txt | `requirements.txt` |

---

## 필요 패키지

```
fastapi>=0.109.0
uvicorn[standard]>=0.27.0
pydantic>=2.5.0
pydantic-settings>=2.1.0
sqlalchemy>=2.0.25
asyncpg>=0.29.0
aiosqlite>=0.19.0
redis>=5.0.0
passlib[bcrypt]>=1.7.4
python-multipart>=0.0.6
# 기존 crawler용
playwright>=1.40.0
```

---

## 완료 기준
1. `DB_TYPE=sqlite`, `SESSION_STORE_TYPE=memory`로 앱 실행 가능
2. 시드 스크립트로 admin 계정 생성
3. `/auth/login`, `/auth/logout`, `/auth/session` API 동작
4. 세션 쿠키 기반 인증, Remember Me 지원
