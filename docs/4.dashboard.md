# Phase 4: 작업 기록 + Dashboard 개발 계획

> 블로그 포스팅, 언론 기사, 카페 침투 관리 + Dashboard API 구현
> Phase 3 패턴을 따르며, 캘린더 쿼리 지원

---

## 1. 개요

Phase 4는 업체가 수행한 작업 내역을 기록/조회하는 기능과 Dashboard API를 구현합니다.

### 1.1 작업 유형 (3가지)
| 유형 | 설명 | 특징 |
|------|------|------|
| BlogPosting | 브랜드 블로그 포스팅 기록 | 업체가 CRUD, 관리자/광고주는 읽기 |
| PressArticle | 언론 기사 | 관리자가 CRUD, 업체/광고주는 읽기 |
| CafeInfiltration | 카페 침투 | 관리자가 CRUD, 업체/광고주는 읽기 |

### 1.2 Dashboard API (3개 - 통합)
| 사용자 | 엔드포인트 | 설명 |
|--------|-----------|------|
| Admin | `/admin/dashboard` | 통계 + 최근 승인 요청 (5건) |
| Agency | `/agency/dashboard` | 통계 + 최근 추적 현황 (5건) |
| Advertiser | `/advertiser/dashboard` | 통계 + 최근 추적 현황 (5건) |

### 1.3 사용자별 권한

| 기능 | Admin | Agency | Advertiser |
|------|-------|--------|------------|
| BlogPosting | R | CRUD | R |
| PressArticle | CRUD | R | R |
| CafeInfiltration | CRUD | R | R |
| Dashboard | O | O | O |

### 1.4 캘린더 쿼리 지원
- `?year=2024&month=1` - 월별 조회
- **dailyCounts 포함**: 날짜별 데이터 갯수 (캘린더 UI용)

---

## 2. 신규 모델 (3개)

### 2.1 디렉토리 구조
```
app/models/work_records/
├── __init__.py
├── blog_posting.py       # BlogPosting
├── press_article.py      # PressArticle
└── cafe_infiltration.py  # CafeInfiltration
```

### 2.2 모델 스키마

**BlogPosting** (업체가 작성한 블로그 포스팅)
| 필드 | 타입 | 설명 |
|------|------|------|
| id | int | PK |
| agency_id | int | 작성 업체 ID |
| advertiser_id | int | 광고주 ID |
| keyword | str | 키워드 |
| url | str | 포스팅 URL |
| posting_date | date | 포스팅 날짜 |
| created_at | datetime | 생성일 |
| updated_at | datetime | 수정일 |

**PressArticle** (언론 기사)
| 필드 | 타입 | 설명 |
|------|------|------|
| id | int | PK |
| advertiser_id | int | 광고주 ID |
| article_date | date | 기사 날짜 |
| title | str | 기사 제목 |
| content | str (nullable) | 기사 내용/설명 |
| url | str (nullable) | 기사 URL |
| created_at | datetime | 생성일 |
| updated_at | datetime | 수정일 |

**CafeInfiltration** (카페 침투)
| 필드 | 타입 | 설명 |
|------|------|------|
| id | int | PK |
| advertiser_id | int | 광고주 ID |
| infiltration_date | date | 침투 날짜 |
| title | str | 제목 |
| content | str (nullable) | 내용 |
| cafe_name | str (nullable) | 카페 이름 |
| url | str (nullable) | 게시글 URL |
| created_at | datetime | 생성일 |
| updated_at | datetime | 수정일 |

---

## 3. API 엔드포인트 (22개)

### 3.1 관리자 API (10개)

**Dashboard** (`app/routers/admin/dashboard.py`)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/admin/dashboard` | 대시보드 통합 (통계 + 최근 승인 요청 5건) |

**블로그 포스팅** (`app/routers/admin/blog_posting.py`)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/admin/blog-posting` | 전체 블로그 포스팅 목록 (검색) |

**언론 기사** (`app/routers/admin/press.py`)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/admin/press` | 언론 기사 목록 (월별/날짜별 + dailyCounts) |
| POST | `/admin/press` | 언론 기사 등록 |
| PUT | `/admin/press/{id}` | 언론 기사 수정 |
| DELETE | `/admin/press/{id}` | 언론 기사 삭제 |

**카페 침투** (`app/routers/admin/cafe_infiltration.py`)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/admin/cafe-infiltration` | 카페 침투 목록 (월별/날짜별 + dailyCounts) |
| POST | `/admin/cafe-infiltration` | 카페 침투 등록 |
| PUT | `/admin/cafe-infiltration/{id}` | 카페 침투 수정 |
| DELETE | `/admin/cafe-infiltration/{id}` | 카페 침투 삭제 |

### 3.2 업체 API (8개)

**Dashboard** (`app/routers/agency/dashboard.py`)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/agency/dashboard` | 대시보드 통합 (통계 + 최근 추적 현황 5건) |

**블로그 포스팅** (`app/routers/agency/blog_posting.py`)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/agency/blog-posting` | 블로그 포스팅 목록 (본인 업체만) |
| POST | `/agency/blog-posting` | 블로그 포스팅 등록 |
| GET | `/agency/blog-posting/{id}` | 블로그 포스팅 상세 |
| PUT | `/agency/blog-posting/{id}` | 블로그 포스팅 수정 |
| DELETE | `/agency/blog-posting/{id}` | 블로그 포스팅 삭제 |

**언론 기사** (`app/routers/agency/press.py`)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/agency/press` | 언론 기사 목록 (매핑된 광고주만 + dailyCounts) |

**카페 침투** (`app/routers/agency/cafe_infiltration.py`)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/agency/cafe-infiltration` | 카페 침투 목록 (매핑된 광고주만 + dailyCounts) |

### 3.3 광고주 API (4개)

**Dashboard** (`app/routers/advertiser/dashboard.py`)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/advertiser/dashboard` | 대시보드 통합 (통계 + 최근 추적 현황 5건) |

**블로그 포스팅** (`app/routers/advertiser/blog_posting.py`)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/advertiser/blog-posting` | 블로그 포스팅 목록 (본인만) |

**언론 기사** (`app/routers/advertiser/press.py`)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/advertiser/press` | 언론 기사 목록 (본인만 + dailyCounts) |

**카페 침투** (`app/routers/advertiser/cafe_infiltration.py`)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/advertiser/cafe-infiltration` | 카페 침투 목록 (본인만 + dailyCounts) |

---

## 4. 스키마 (Request/Response)

### 4.1 디렉토리 구조
```
app/schemas/
├── dashboard/
│   ├── __init__.py
│   ├── admin.py          # Admin 대시보드 스키마
│   ├── agency.py         # Agency 대시보드 스키마
│   └── advertiser.py     # Advertiser 대시보드 스키마
├── work_records/
│   ├── __init__.py
│   ├── common.py         # 공통 스키마 (CalendarFilter, DailyCount)
│   ├── blog_posting.py   # 블로그 포스팅 스키마
│   ├── press_article.py  # 언론 기사 스키마
│   └── cafe_infiltration.py  # 카페 침투 스키마
```

### 4.2 Dashboard 스키마 (통합)

**Admin Dashboard** - 통계 + 최근 승인 요청
```python
class AdminDashboardResponse(BaseModel):
    # 통계
    pending_signup_count: int      # 승인 대기 수
    advertiser_count: int          # 전체 광고주 수
    agency_count: int              # 전체 업체 수
    # 최근 승인 요청 (5건)
    recent_requests: list[RecentSignupRequest]

class RecentSignupRequest(BaseModel):
    id: int
    login_id: str
    role: str
    created_at: datetime
```

**Agency Dashboard** - 통계 + 최근 추적 현황
```python
class AgencyDashboardResponse(BaseModel):
    # 통계
    mapped_advertiser_count: int   # 매핑된 광고주 수
    active_tracking_count: int     # 활성 추적 수
    blog_posting_count: int        # 블로그 포스팅 수
    # 최근 추적 현황 (5건)
    recent_tracking: list[RecentTracking]

class RecentTracking(BaseModel):
    id: int
    type: RankType
    keyword: str
    latest_rank: int | None
    advertiser_name: str
```

**Advertiser Dashboard** - 통계 + 최근 추적 현황
```python
class AdvertiserDashboardResponse(BaseModel):
    # 통계
    mapped_agency_count: int       # 매핑된 업체 수
    active_tracking_count: int     # 활성 추적 수
    blog_posting_count: int        # 블로그 포스팅 수
    # 최근 추적 현황 (5건)
    recent_tracking: list[RecentTracking]
```

### 4.3 캘린더 공통 스키마

```python
class DailyCount(BaseModel):
    date: str           # "2024-01-15"
    day_of_week: str    # "월", "화", "수", "목", "금", "토", "일"
    count: int          # 해당 날짜의 데이터 수

class CalendarListResponse(BaseModel):
    # 해당 월의 전체 데이터 목록 (페이지네이션 없음)
    items: list[...]

    # items 개수 (= len(items))
    total: int

    # 캘린더 UI용 날짜별 통계
    daily_counts: list[DailyCount]
```

**특징:**
- `items`: 해당 월의 **전체 데이터** (페이지네이션 없음, 한 번에 모두 반환)
- `total`: items 개수 (= len(items))
- `daily_counts`: 날짜별 데이터 개수 (캘린더에 점/숫자 표시용)

**응답 예시** (`?year=2024&month=1`)
```json
{
  "items": [
    {"id": 1, "title": "기사1", "article_date": "2024-01-05"},
    {"id": 2, "title": "기사2", "article_date": "2024-01-05"},
    {"id": 3, "title": "기사3", "article_date": "2024-01-05"},
    {"id": 4, "title": "기사4", "article_date": "2024-01-12"},
    ... // 해당 월의 전체 데이터
  ],
  "total": 15,
  "daily_counts": [
    {"date": "2024-01-05", "day_of_week": "금", "count": 3},
    {"date": "2024-01-12", "day_of_week": "금", "count": 5},
    {"date": "2024-01-20", "day_of_week": "토", "count": 7}
  ]
}
```

### 4.4 Work Records 스키마

**BlogPosting 스키마**
- `BlogPostingCreateRequest`: keyword, url, advertiser_id, posting_date
- `BlogPostingUpdateRequest`: keyword?, url?, advertiser_id?, posting_date?
- `BlogPostingListItem`: id, keyword, url, posting_date, advertiser_info
- `BlogPostingListResponse`: items[], total
- `BlogPostingDetailResponse`: 상세 정보 + agency/advertiser 정보

**PressArticle 스키마**
- `PressArticleCreateRequest`: advertiser_id, article_date, title, content?, url?
- `PressArticleUpdateRequest`: article_date?, title?, content?, url?
- `PressArticleListItem`: id, article_date, title, url, advertiser_info
- `PressArticleCalendarResponse`: items[], total, daily_counts[]

**CafeInfiltration 스키마**
- `CafeInfiltrationCreateRequest`: advertiser_id, infiltration_date, title, content?, cafe_name?, url?
- `CafeInfiltrationUpdateRequest`: infiltration_date?, title?, content?, cafe_name?, url?
- `CafeInfiltrationListItem`: id, infiltration_date, title, cafe_name, advertiser_info
- `CafeInfiltrationCalendarResponse`: items[], total, daily_counts[]

---

## 5. 서비스/레포지토리

### 5.1 디렉토리 구조
```
app/services/
├── dashboard/
│   ├── __init__.py
│   ├── admin_dashboard_service.py
│   ├── agency_dashboard_service.py
│   └── advertiser_dashboard_service.py
├── work_records/
│   ├── __init__.py
│   ├── blog_posting_service.py
│   ├── press_article_service.py
│   └── cafe_infiltration_service.py

app/repositories/work_records/
├── __init__.py
├── blog_posting_repository.py
├── press_article_repository.py
└── cafe_infiltration_repository.py
```

### 5.2 레포지토리 메서드 (공통 패턴)

```python
class BlogPostingRepository:
    async def get_by_id(id: int) -> BlogPosting | None
    async def create(data: dict) -> BlogPosting
    async def update(id: int, data: dict) -> BlogPosting
    async def delete(id: int) -> bool
    async def get_list(
        agency_id: int | None,
        advertiser_id: int | None,
        keyword: str | None,
        skip: int, limit: int
    ) -> list[BlogPosting]
    async def count(...) -> int

class PressArticleRepository:
    async def get_by_id(id: int) -> PressArticle | None
    async def create(data: dict) -> PressArticle
    async def update(id: int, data: dict) -> PressArticle
    async def delete(id: int) -> bool
    async def get_list(
        advertiser_id: int | None,
        advertiser_ids: list[int] | None,  # 업체용 (매핑된 광고주들)
        year: int | None, month: int | None,
        date: date | None,
        skip: int, limit: int
    ) -> list[PressArticle]
    async def count(...) -> int

# CafeInfiltrationRepository - PressArticle과 동일 패턴
```

### 5.3 서비스 메서드

**Dashboard 서비스 (통합)**
```python
class AdminDashboardService:
    async def get_dashboard() -> AdminDashboardResponse
    # 내부에서 통계 + 최근 승인 요청 5건 조회

class AgencyDashboardService:
    async def get_dashboard(agency_id: int) -> AgencyDashboardResponse
    # 내부에서 통계 + 최근 추적 현황 5건 조회

class AdvertiserDashboardService:
    async def get_dashboard(advertiser_id: int) -> AdvertiserDashboardResponse
    # 내부에서 통계 + 최근 추적 현황 5건 조회
```

**Work Records 서비스**
```python
class BlogPostingService:
    # 목록 조회 (역할별 필터링)
    async def get_list(filters, user_context) -> (list, total)

    # 상세 조회 (권한 검증)
    async def get_detail(id: int, user_context) -> BlogPostingDetail

    # 등록 (Agency 전용)
    async def create(data, agency_id: int) -> BlogPosting

    # 수정 (Agency 전용 + 본인 것만)
    async def update(id: int, data, agency_id: int) -> BlogPosting

    # 삭제 (Agency 전용 + 본인 것만)
    async def delete(id: int, agency_id: int) -> bool

class PressArticleService:
    # 목록 조회 (역할별 + daily_counts 포함)
    # - Admin: 전체
    # - Agency: 매핑된 광고주만
    # - Advertiser: 본인만
    async def get_calendar_list(filters, user_context) -> CalendarListResponse

    # CRUD (Admin 전용)
    async def create(data) -> PressArticle
    async def update(id: int, data) -> PressArticle
    async def delete(id: int) -> bool

# CafeInfiltrationService - PressArticle과 동일 패턴
```

---

## 6. 핵심 비즈니스 로직

### 6.1 권한 검증

**BlogPosting**
- 등록/수정/삭제: Agency만 가능, 본인 업체 데이터만
- 조회:
  - Admin: 전체 조회
  - Agency: 본인 업체가 등록한 데이터만
  - Advertiser: 본인에게 매핑된 데이터만

**PressArticle / CafeInfiltration**
- 등록/수정/삭제: Admin만 가능
- 조회:
  - Admin: 전체 조회
  - Agency: 매핑된 광고주 데이터만 (AgencyAdvertiserMapping 활용)
  - Advertiser: 본인 데이터만

### 6.2 업체의 매핑된 광고주 조회

```python
# Agency가 Press/CafeInfiltration 조회 시
# 1. 현재 업체에 매핑된 광고주 ID 목록 조회
mapped_advertiser_ids = await mapping_repo.get_advertiser_ids_by_agency(agency_id)

# 2. 해당 광고주들의 데이터만 필터링
items = await press_repo.get_list(advertiser_ids=mapped_advertiser_ids, ...)
```

### 6.3 캘린더 쿼리 로직

```python
# 필터 적용 우선순위: date > year+month
if filters.date:
    # 특정 날짜만 조회
    query = query.where(PressArticle.article_date == filters.date)
elif filters.year and filters.month:
    # 해당 월 전체 조회
    start_date = date(filters.year, filters.month, 1)
    end_date = date(filters.year, filters.month + 1, 1) - timedelta(days=1)
    query = query.where(PressArticle.article_date.between(start_date, end_date))
```

---

## 7. 구현 순서

### Step 1: 모델
1. `app/models/work_records/__init__.py` 생성
2. `blog_posting.py` - BlogPosting 모델
3. `press_article.py` - PressArticle 모델
4. `cafe_infiltration.py` - CafeInfiltration 모델
5. `app/models/__init__.py` 업데이트

### Step 2: 레포지토리
1. `app/repositories/work_records/__init__.py`
2. `blog_posting_repository.py`
3. `press_article_repository.py`
4. `cafe_infiltration_repository.py`

### Step 3: 스키마
1. `app/schemas/dashboard/__init__.py`
2. `app/schemas/dashboard/admin.py`
3. `app/schemas/dashboard/agency.py`
4. `app/schemas/dashboard/advertiser.py`
5. `app/schemas/work_records/__init__.py`
6. `app/schemas/work_records/common.py` (DailyCount, CalendarFilter)
7. `app/schemas/work_records/blog_posting.py`
8. `app/schemas/work_records/press_article.py`
9. `app/schemas/work_records/cafe_infiltration.py`

### Step 4: 서비스
1. `app/services/dashboard/__init__.py`
2. `app/services/dashboard/admin_dashboard_service.py`
3. `app/services/dashboard/agency_dashboard_service.py`
4. `app/services/dashboard/advertiser_dashboard_service.py`
5. `app/services/work_records/__init__.py`
6. `app/services/work_records/blog_posting_service.py`
7. `app/services/work_records/press_article_service.py`
8. `app/services/work_records/cafe_infiltration_service.py`

### Step 5: 관리자 라우터
1. `app/routers/admin/dashboard.py` (통합)
2. `app/routers/admin/blog_posting.py` (읽기 전용)
3. `app/routers/admin/press.py` (Full CRUD)
4. `app/routers/admin/cafe_infiltration.py` (Full CRUD)
5. `app/routers/admin/__init__.py` 업데이트

### Step 6: 업체 라우터
1. `app/routers/agency/dashboard.py` (통합)
2. `app/routers/agency/blog_posting.py` (Full CRUD)
3. `app/routers/agency/press.py` (읽기 전용)
4. `app/routers/agency/cafe_infiltration.py` (읽기 전용)
5. `app/routers/agency/__init__.py` 업데이트

### Step 7: 광고주 라우터
1. `app/routers/advertiser/dashboard.py` (통합)
2. `app/routers/advertiser/blog_posting.py` (읽기 전용)
3. `app/routers/advertiser/press.py` (읽기 전용)
4. `app/routers/advertiser/cafe_infiltration.py` (읽기 전용)
5. `app/routers/advertiser/__init__.py` 업데이트

### Step 8: main.py 라우터 등록
1. `app/routers/__init__.py` 업데이트
2. `app/main.py` 라우터 등록 (12개 신규 라우터)

### Step 9: 테스트 및 검증
1. 모델 마이그레이션 테스트
2. Dashboard API 테스트
3. Work Records API 테스트
4. 권한 검증 테스트
5. 캘린더 쿼리 (daily_counts) 테스트

---

## 8. 파일 생성 목록 (신규 32개)

```
app/
├── models/work_records/
│   ├── __init__.py
│   ├── blog_posting.py
│   ├── press_article.py
│   └── cafe_infiltration.py
├── repositories/work_records/
│   ├── __init__.py
│   ├── blog_posting_repository.py
│   ├── press_article_repository.py
│   └── cafe_infiltration_repository.py
├── schemas/
│   ├── dashboard/
│   │   ├── __init__.py
│   │   ├── admin.py
│   │   ├── agency.py
│   │   └── advertiser.py
│   └── work_records/
│       ├── __init__.py
│       ├── common.py            # DailyCount, CalendarFilter
│       ├── blog_posting.py
│       ├── press_article.py
│       └── cafe_infiltration.py
├── services/
│   ├── dashboard/
│   │   ├── __init__.py
│   │   ├── admin_dashboard_service.py
│   │   ├── agency_dashboard_service.py
│   │   └── advertiser_dashboard_service.py
│   └── work_records/
│       ├── __init__.py
│       ├── blog_posting_service.py
│       ├── press_article_service.py
│       └── cafe_infiltration_service.py
├── routers/admin/
│   ├── dashboard.py         # 신규 (1 endpoint - 통합)
│   ├── blog_posting.py      # 신규 (1 endpoint)
│   ├── press.py             # 신규 (4 endpoints)
│   └── cafe_infiltration.py # 신규 (4 endpoints)
├── routers/agency/
│   ├── dashboard.py         # 신규 (1 endpoint - 통합)
│   ├── blog_posting.py      # 신규 (5 endpoints)
│   ├── press.py             # 신규 (1 endpoint)
│   └── cafe_infiltration.py # 신규 (1 endpoint)
└── routers/advertiser/
    ├── dashboard.py         # 신규 (1 endpoint - 통합)
    ├── blog_posting.py      # 신규 (1 endpoint)
    ├── press.py             # 신규 (1 endpoint)
    └── cafe_infiltration.py # 신규 (1 endpoint)
```

---

## 9. 수정 파일 목록 (기존 7개)

| 파일 | 변경 내용 |
|------|----------|
| `app/models/__init__.py` | work_records 모델 export |
| `app/routers/__init__.py` | 신규 라우터 export (12개 추가) |
| `app/routers/admin/__init__.py` | 4개 라우터 import/export |
| `app/routers/agency/__init__.py` | 4개 라우터 import/export |
| `app/routers/advertiser/__init__.py` | 4개 라우터 import/export |
| `app/main.py` | 12개 신규 라우터 등록 |
| `.github/03.api.md` | Dashboard API 통합 반영 (6개→3개) |

---

## 10. 참고 파일 (기존 패턴)

| 파일 | 참고 내용 |
|------|----------|
| `app/models/tracking/rank_tracking.py` | 모델 패턴, 관계 정의 |
| `app/repositories/tracking/rank_tracking_repository.py` | 레포지토리 패턴, 필터링 |
| `app/services/rank/rank_service.py` | 서비스 패턴, 권한 처리 |
| `app/routers/admin/place_rank.py` | Admin 라우터 패턴 |
| `app/routers/agency/place_rank.py` | Agency 라우터 패턴, get_agency_id |
| `app/routers/advertiser/place_rank.py` | Advertiser 라우터 패턴 |
| `app/schemas/tracking/common.py` | 스키마 패턴 |
| `app/repositories/agency_advertiser_mapping_repository.py` | 매핑 조회 (Agency용) |

---

## 11. API 개수 요약

| 사용자 유형 | Dashboard | BlogPosting | PressArticle | CafeInfiltration | 합계 |
|------------|-----------|-------------|--------------|------------------|------|
| Admin | 1 (통합) | 1 (R) | 4 (CRUD) | 4 (CRUD) | 10개 |
| Agency | 1 (통합) | 5 (CRUD) | 1 (R) | 1 (R) | 8개 |
| Advertiser | 1 (통합) | 1 (R) | 1 (R) | 1 (R) | 4개 |
| **총합** | 3개 | 7개 | 6개 | 6개 | **22개** |

---

## 12. 예상 작업량

| 단계 | 작업 내용 | 예상 시간 |
|------|----------|----------|
| Step 1 | 모델 생성 (3개) | 2-3시간 |
| Step 2 | 레포지토리 (3개) | 4-5시간 |
| Step 3 | 스키마 (Dashboard 4개 + WorkRecords 5개) | 3-4시간 |
| Step 4 | 서비스 (Dashboard 3개 + WorkRecords 3개) | 5-6시간 |
| Step 5-7 | 라우터 (12개) | 6-8시간 |
| Step 8 | 라우터 등록 + .github 문서 수정 | 1-2시간 |
| Step 9 | 테스트/검증 | 4-5시간 |
| **합계** | | **25-33시간** |
