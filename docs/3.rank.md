# Phase 3: 순위 관리 (Rank Management) 개발 계획

> Dashboard API 제외, 순위 관련 API만 구현
> Full filtering/search/pagination 지원

---

## 1. 개요

Phase 3는 네이버 검색 순위 추적 기능을 구현합니다.
- **3가지 순위 유형**: 플레이스(place), 카페(cafe), 블로그(blog)
- **3가지 사용자 유형**: 관리자(Admin), 업체(Agency), 광고주(Advertiser)
- **핵심 기능**: 실시간 순위 조회, 추적 등록/목록/상세, 추적 중단

---

## 2. 신규 모델 (2개)

### 2.1 디렉토리 구조
```
app/models/tracking/
├── __init__.py
├── rank_tracking.py   # RankTracking, RankHistory (통합 모델)
```

### 2.2 모델 스키마

**RankType Enum**
```python
class RankType(str, Enum):
    PLACE = "place"    # 플레이스 순위
    CAFE = "cafe"      # 카페 글 순위
    BLOG = "blog"      # 블로그 글 순위
```

**TrackingStatus Enum**
```python
class TrackingStatus(str, Enum):
    ACTIVE = "active"
    STOPPED = "stopped"
```

**RankTracking**
| 필드 | 타입 | 설명 |
|------|------|------|
| id | int | PK |
| type | RankType | 순위 유형 (place/cafe/blog) |
| agency_id | int | FK(agencies.id) |
| advertiser_id | int | FK(advertisers.id) |
| keyword | str | 검색 키워드 |
| url | str | 추적 대상 URL |
| status | TrackingStatus | active/stopped |
| current_session | int | 현재 회차 (default: 1) - 배치 로직 상태값 |
| created_at | datetime | 생성일 |
| updated_at | datetime | 수정일 |

**RankHistory**
| 필드 | 타입 | 설명 |
|------|------|------|
| id | int | PK |
| tracking_id | int | FK(rank_trackings.id) |
| rank | int (nullable) | 순위 (null=미노출) |
| session_number | int | 회차 번호 |
| checked_at | datetime | 체크 일시 |

---

## 3. API 엔드포인트 (31개)

### 3.1 관리자 API (12개)

**플레이스 순위** (`app/routers/admin/place_rank.py`)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/admin/place-rank/realtime` | 실시간 순위 조회 (DB 저장 X) |
| GET | `/admin/place-rank/tracking` | 추적 목록 (필터, 검색, 페이지네이션) |
| GET | `/admin/place-rank/tracking/{id}` | 추적 상세 + 히스토리 |
| PUT | `/admin/place-rank/tracking/{id}/stop` | 추적 중단 |

**카페 순위** (`app/routers/admin/cafe_rank.py`)
- 플레이스와 동일 구조 (4개)

**블로그 순위** (`app/routers/admin/blog_rank.py`)
- 플레이스와 동일 구조 (4개)

### 3.2 업체 API (13개)

**플레이스 순위** (`app/routers/agency/place_rank.py`)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/agency/place-rank/realtime` | 실시간 순위 조회 |
| GET | `/agency/place-rank/tracking` | 본인 업체 추적 목록 |
| POST | `/agency/place-rank/tracking` | 추적 등록 |
| GET | `/agency/place-rank/tracking/{id}` | 추적 상세 |

**카페/블로그 순위** - 플레이스와 동일 (각 4개)

**공통** (`app/routers/agency/common.py`)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/agency/advertisers` | 매핑된 광고주 목록 |

### 3.3 광고주 API (6개)

**플레이스 순위** (`app/routers/advertiser/place_rank.py`)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/advertiser/place-rank/tracking` | 본인 매핑 추적 목록 |
| GET | `/advertiser/place-rank/tracking/{id}` | 추적 상세 |

**카페/블로그 순위** - 플레이스와 동일 (각 2개)

---

## 4. 스키마 (Request/Response)

### 4.1 디렉토리 구조
```
app/schemas/
├── tracking/
│   ├── __init__.py
│   ├── common.py          # 공통 스키마 (RankType, TrackingStatus)
│   ├── place_rank.py      # 플레이스 스키마
│   ├── cafe_rank.py       # 카페 스키마
│   └── blog_rank.py       # 블로그 스키마
└── agency.py              # 업체용 공통 스키마 (advertisers)
```

### 4.2 주요 스키마

**실시간 조회**
- `RealtimeRankRequest`: keyword, url (Query params)
- `RealtimeRankResponse`: keyword, url, rank (int | null), checked_at

**추적 목록**
- `TrackingListRequest`: status?, advertiser_id?, keyword?, skip, limit
- `TrackingListResponse`: items[], total

**추적 등록 (Agency)**
- `TrackingCreateRequest`: keyword, url, advertiser_id

**추적 상세**
- `TrackingDetailResponse`: 기본 정보 + histories[]
- `RankHistoryItem`: rank, session_number(회차), checked_at

---

## 5. 서비스/레포지토리

### 5.1 디렉토리 구조
```
app/services/rank/
├── __init__.py
├── rank_service.py        # 통합 순위 서비스

app/repositories/tracking/
├── __init__.py
├── rank_tracking_repository.py    # RankTracking 레포지토리
├── rank_history_repository.py     # RankHistory 레포지토리
```

### 5.2 서비스 메서드

```python
class RankService:
    # 실시간 순위 조회 (크롤러 호출)
    async def get_realtime_rank(type: RankType, keyword, url) -> RankResult

    # 추적 목록 (역할별 필터링)
    async def get_tracking_list(type: RankType, filters, user) -> (list, total)

    # 추적 상세 + 히스토리
    async def get_tracking_detail(tracking_id, user) -> TrackingDetail

    # 추적 등록 (Agency 전용)
    # - 등록 시 1회차 첫 번째 순위 즉시 크롤링하여 저장
    async def create_tracking(type: RankType, data, agency_id) -> Tracking

    # 추적 중단 (Admin 전용)
    async def stop_tracking(tracking_id) -> Tracking
```

---

## 6. 핵심 비즈니스 로직

### 6.1 회차 계산
- 25회 노출 = 1 회차
- 미노출(rank=null) 일은 카운트에서 제외
- 회차 전환 시 current_session 증가

### 6.2 추적 등록 시 초기 순위
- 추적 등록 시 즉시 크롤링 수행
- 1회차의 첫 번째 순위로 RankHistory에 저장
- 사용자가 등록 직후 바로 현재 순위 확인 가능

### 6.3 실시간 vs 추적
- **실시간**: 즉시 크롤링 → 결과 반환 (DB 저장 X)
- **추적**: 등록 시 초기 순위 저장 + Phase 5 배치에서 일일 크롤링

### 6.4 접근 권한
| 역할 | 조회 범위 | 등록 | 중단 |
|------|----------|------|------|
| Admin | 전체 | X | O |
| Agency | 본인 업체만 | O | X |
| Advertiser | 본인 매핑만 | X | X |

### 6.5 URL 파싱
- 기존 `app/crawler/naver.py`의 extract_* 함수 활용
- `extract_place_id(url)` → place_id
- `extract_blog_id(url)` → (blog_id, log_no)
- `extract_cafe_id(url)` → (cafe_id, article_id)

---

## 7. 구현 순서

### Step 1: 모델
1. `app/models/tracking/__init__.py` 생성
2. `rank_tracking.py` - RankTracking, RankHistory 통합 모델
3. `app/models/__init__.py` 업데이트

### Step 2: 레포지토리
1. `app/repositories/tracking/__init__.py`
2. `rank_tracking_repository.py`
3. `rank_history_repository.py`

### Step 3: 스키마
1. `app/schemas/tracking/__init__.py`
2. `common.py` - 공통 스키마 (RankType, TrackingStatus)
3. `place_rank.py`, `cafe_rank.py`, `blog_rank.py`
4. `app/schemas/agency.py` - 광고주 목록 응답

### Step 4: 서비스
1. `app/services/rank/__init__.py`
2. `rank_service.py` - 통합 순위 서비스

### Step 5: 관리자 라우터
1. `app/routers/admin/place_rank.py`
2. `app/routers/admin/cafe_rank.py`
3. `app/routers/admin/blog_rank.py`
4. `app/main.py` 라우터 등록

### Step 6: 업체 라우터
1. `app/routers/agency/__init__.py`
2. `app/routers/agency/place_rank.py`
3. `app/routers/agency/cafe_rank.py`
4. `app/routers/agency/blog_rank.py`
5. `app/routers/agency/common.py` - advertisers 조회

### Step 7: 광고주 라우터
1. `app/routers/advertiser/__init__.py`
2. `app/routers/advertiser/place_rank.py`
3. `app/routers/advertiser/cafe_rank.py`
4. `app/routers/advertiser/blog_rank.py`

### Step 8: 테스트 및 검증
1. API 테스트
2. 크롤러 연동 테스트
3. 권한 검증

---

## 8. 수정 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `app/models/__init__.py` | tracking 모델 export |
| `app/main.py` | 신규 라우터 등록 |
| `app/core/dependencies.py` | 필요시 의존성 추가 |

---

## 9. 파일 생성 목록 (신규)

```
app/
├── models/tracking/
│   ├── __init__.py
│   └── rank_tracking.py       # RankTracking, RankHistory 통합
├── repositories/tracking/
│   ├── __init__.py
│   ├── rank_tracking_repository.py
│   └── rank_history_repository.py
├── services/rank/
│   ├── __init__.py
│   └── rank_service.py        # 통합 서비스
├── schemas/tracking/
│   ├── __init__.py
│   ├── common.py
│   ├── place_rank.py
│   ├── cafe_rank.py
│   └── blog_rank.py
├── schemas/agency.py
├── routers/admin/
│   ├── place_rank.py
│   ├── cafe_rank.py
│   └── blog_rank.py
├── routers/agency/
│   ├── __init__.py
│   ├── place_rank.py
│   ├── cafe_rank.py
│   ├── blog_rank.py
│   └── common.py
└── routers/advertiser/
    ├── __init__.py
    ├── place_rank.py
    ├── cafe_rank.py
    └── blog_rank.py
```

---

## 10. 주요 참고 파일

| 파일 | 참고 내용 |
|------|----------|
| `app/routers/admin/members.py` | 라우터 패턴, 의존성 주입 |
| `app/services/admin_member_service.py` | 서비스 패턴 |
| `app/repositories/user_repository.py` | 레포지토리 패턴 |
| `app/crawler/naver.py` | 크롤러 함수 (get_place_rank, get_blog_rank, get_cafe_rank) |
| `app/schemas/admin.py` | 스키마 패턴 |
| `.github/03.api.md` | API 명세 |
